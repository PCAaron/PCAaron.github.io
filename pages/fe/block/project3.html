<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实战篇：ICO智能合约开发和Remix测试 | Web全栈技术笔记</title>
    <meta name="description" content="Web技术笔记，记录前端的进阶之路">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.d20cb8b9.css" as="style"><link rel="preload" href="/assets/js/app.2c921ca0.js" as="script"><link rel="preload" href="/assets/js/2.29093f4e.js" as="script"><link rel="preload" href="/assets/js/20.05a49d49.js" as="script"><link rel="prefetch" href="/assets/js/10.e7261647.js"><link rel="prefetch" href="/assets/js/11.3acb9245.js"><link rel="prefetch" href="/assets/js/12.30fa2830.js"><link rel="prefetch" href="/assets/js/13.f7f5633c.js"><link rel="prefetch" href="/assets/js/14.077d15bd.js"><link rel="prefetch" href="/assets/js/15.ca4c6dcf.js"><link rel="prefetch" href="/assets/js/16.33c76806.js"><link rel="prefetch" href="/assets/js/17.c1d108fb.js"><link rel="prefetch" href="/assets/js/18.f2c74917.js"><link rel="prefetch" href="/assets/js/19.4d0677d6.js"><link rel="prefetch" href="/assets/js/21.303ca718.js"><link rel="prefetch" href="/assets/js/22.dd8c450d.js"><link rel="prefetch" href="/assets/js/23.c436f815.js"><link rel="prefetch" href="/assets/js/24.5817cae1.js"><link rel="prefetch" href="/assets/js/25.7640084e.js"><link rel="prefetch" href="/assets/js/26.6981ceda.js"><link rel="prefetch" href="/assets/js/27.d96b5401.js"><link rel="prefetch" href="/assets/js/28.7e5507ca.js"><link rel="prefetch" href="/assets/js/29.0486ec9e.js"><link rel="prefetch" href="/assets/js/3.5ee6df4b.js"><link rel="prefetch" href="/assets/js/30.0705fdc2.js"><link rel="prefetch" href="/assets/js/31.3e20c412.js"><link rel="prefetch" href="/assets/js/32.40154bdb.js"><link rel="prefetch" href="/assets/js/33.54042f7d.js"><link rel="prefetch" href="/assets/js/34.992a68b5.js"><link rel="prefetch" href="/assets/js/35.fe5d31f8.js"><link rel="prefetch" href="/assets/js/36.20985163.js"><link rel="prefetch" href="/assets/js/37.7e0e1be1.js"><link rel="prefetch" href="/assets/js/38.c81dfd87.js"><link rel="prefetch" href="/assets/js/39.799324c8.js"><link rel="prefetch" href="/assets/js/4.505f2474.js"><link rel="prefetch" href="/assets/js/40.4a8ca097.js"><link rel="prefetch" href="/assets/js/41.3bdce235.js"><link rel="prefetch" href="/assets/js/42.13fe7b3a.js"><link rel="prefetch" href="/assets/js/43.b51c1b2e.js"><link rel="prefetch" href="/assets/js/44.408a421f.js"><link rel="prefetch" href="/assets/js/45.63e44fa3.js"><link rel="prefetch" href="/assets/js/46.409b4b6a.js"><link rel="prefetch" href="/assets/js/47.e253242d.js"><link rel="prefetch" href="/assets/js/48.ba57127f.js"><link rel="prefetch" href="/assets/js/49.7637631e.js"><link rel="prefetch" href="/assets/js/5.5326fad8.js"><link rel="prefetch" href="/assets/js/50.5c4dae5f.js"><link rel="prefetch" href="/assets/js/51.5ced2ccf.js"><link rel="prefetch" href="/assets/js/52.0447cb17.js"><link rel="prefetch" href="/assets/js/53.bb22200a.js"><link rel="prefetch" href="/assets/js/54.cbb62dbb.js"><link rel="prefetch" href="/assets/js/55.951cd720.js"><link rel="prefetch" href="/assets/js/56.3026c904.js"><link rel="prefetch" href="/assets/js/57.925dacf9.js"><link rel="prefetch" href="/assets/js/58.32a50715.js"><link rel="prefetch" href="/assets/js/59.f1f9cb40.js"><link rel="prefetch" href="/assets/js/6.9c6dd834.js"><link rel="prefetch" href="/assets/js/60.be19c9ef.js"><link rel="prefetch" href="/assets/js/61.c84c312a.js"><link rel="prefetch" href="/assets/js/62.b2e36c2d.js"><link rel="prefetch" href="/assets/js/7.a22cca04.js"><link rel="prefetch" href="/assets/js/8.34ea0bd8.js"><link rel="prefetch" href="/assets/js/9.224ad97b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d20cb8b9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="Web全栈技术笔记" class="logo"> <span class="site-name can-hide">Web全栈技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fe/vue/" class="nav-link">Vue.js实战</a></li><li class="dropdown-item"><!----> <a href="/pages/fe/webpack/" class="nav-link">玩转webpack4.0</a></li><li class="dropdown-item"><!----> <a href="/pages/fe/chrome/" class="nav-link">浏览器工作原理与实战</a></li><li class="dropdown-item"><!----> <a href="/pages/fe/block/introduce.html" class="nav-link">区块链开发入门</a></li><li class="dropdown-item"><!----> <a href="/pages/fe/git/" class="nav-link">Git命令大全</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/PCAaron/PCAaron.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/aaron-pan/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客园
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fe/vue/" class="nav-link">Vue.js实战</a></li><li class="dropdown-item"><!----> <a href="/pages/fe/webpack/" class="nav-link">玩转webpack4.0</a></li><li class="dropdown-item"><!----> <a href="/pages/fe/chrome/" class="nav-link">浏览器工作原理与实战</a></li><li class="dropdown-item"><!----> <a href="/pages/fe/block/introduce.html" class="nav-link">区块链开发入门</a></li><li class="dropdown-item"><!----> <a href="/pages/fe/git/" class="nav-link">Git命令大全</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/PCAaron/PCAaron.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/aaron-pan/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客园
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>区块链开发简介</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/fe/block/introduce.html" class="sidebar-link">什么是区块链？</a></li><li><a href="/pages/fe/block/history.html" class="sidebar-link">区块链发展史</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>区块链入门篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/fe/block/beginner1.html" class="sidebar-link">区块链核心概念和原理</a></li><li><a href="/pages/fe/block/beginner2.html" class="sidebar-link">以太坊核心概念和原理</a></li><li><a href="/pages/fe/block/beginner3.html" class="sidebar-link">创建以太坊钱包</a></li><li><a href="/pages/fe/block/beginner4.html" class="sidebar-link">完成第一笔交易</a></li><li><a href="/pages/fe/block/beginner5.html" class="sidebar-link">深入理解以太坊中的交易</a></li><li><a href="/pages/fe/block/beginner6.html" class="sidebar-link">solidity</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>区块链进阶篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/fe/block/improve1.html" class="sidebar-link">自建智能合约工作流</a></li><li><a href="/pages/fe/block/improve2.html" class="sidebar-link">编写智能合同编译脚本：compile</a></li><li><a href="/pages/fe/block/improve3.html" class="sidebar-link">智能合约部署脚本</a></li><li><a href="/pages/fe/block/improve4.html" class="sidebar-link">使用mocha+web3.js+ganache编写合约测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>区块链实战篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/fe/block/project1.html" class="sidebar-link">ICO DApp 要解决什么问题</a></li><li><a href="/pages/fe/block/project2.html" class="sidebar-link">ICO 智能合约的数据结构和接口设计</a></li><li><a href="/pages/fe/block/project3.html" class="active sidebar-link">ICO智能合约开发和Remix测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/fe/block/project3.html#ico合约初版" class="sidebar-link">ICO合约初版</a></li><li class="sidebar-sub-header"><a href="/pages/fe/block/project3.html#remix合约校验" class="sidebar-link">Remix合约校验</a></li><li class="sidebar-sub-header"><a href="/pages/fe/block/project3.html#star-or-打赏" class="sidebar-link">star or 打赏</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ico智能合约开发和remix测试"><a href="#ico智能合约开发和remix测试" class="header-anchor">#</a> ICO智能合约开发和Remix测试</h1> <h2 id="ico合约初版"><a href="#ico合约初版" class="header-anchor">#</a> ICO合约初版</h2> <blockquote><p>撸个简单的智能合约，完成ICO参与，发起资金支出，投票，完成支出等模块功能</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>pragma solidity ^0.4.17;

contract Project {
    // 定义Payment结构体
    struct Payment{
        string description;
        // 状态变量uint(会永久存储在合约的存储空间)
        uint amount;
        address receiver;
        bool completed;
        address[] voters;
    }

    /**
    合约属性声明
    owner，项目所有者；
    description，项目介绍；
    minInvest，最小投资金额；
    maxInvest，最大投资金额；
    goal，融资上限；
    investors，投资人列表；
    payments，资金支出列表；
    **/
    address public owner;
    string public description;
    uint public minInvest;
    uint public maxInvest;
    uint public goal;
    address[] public investors;
    Payment[] public payments;

    // 定义构造器:在合约的构造器中，不能使用this调用函数，因为当前合约还没有创建完成
    constructor(string _description,uint _minInvest,uint _maxInvest,uint _goal) public{
        owner=msg.sender;
        description=_description;
        minInvest=_minInvest;
        maxInvest=_maxInvest;
        goal=_goal;
    }

    /**
    contribute:参与项目投资的接口
    投资人调用该接口时要求发送满足条件的资金，并且要求没有达到募资上线，这是所有合约接口中标记为 payable 的接口，即接受用户在交易中发送 ETH
    msg、require 是 Solidity中的全局变量，另还有block、now、tx等(见http://solidity.readthedocs.io/en/v0.4.24/units-and-global-variables.html#block-and-transaction-properties)
    msg包含了当前交易上的关键信息：
        msg.data，交易中携带的数据，在我们的代码中没有用到；
        msg.sender，发起交易的账户，在众筹合约中大量使用，记录投资者和投票；
        msg.value，交易发送的转账金额，比如投资金额检查就用到了，需要注意的是 msg.value 的单位是 wei...
    require : Solidity 提供的断言机制,如果不满足交易则回滚
    */
    function contribute() public payable{
        require(msg.value &gt;= minInvest);
        require(msg.value &lt;= maxInvest);
        require(address(this).balance &lt;= goal);
        investors.push(msg.sender);
    }

    /**
    createPayment:发起资金支出请求
    要求传入资金支出的细节信息
    */
    function createPayment(string _description, uint _amount, address _receiver) public {
        Payment memory newPayment = Payment({
            description:_description,
            amount:_amount,
            receiver:_receiver,
            completed:false,
            voters:new address[](0)
            });
        payments.push(newPayment);
    }

    /**
    approvePayment:，投票赞成某个资金支出请求
    需要指定是哪条请求，要求投票的人是投资人，并且没有重复投票
    */
    function approvePayment(uint index) public{
        Payment storage payment=payments[index];
        bool isInvestor=false;
        for(uint i=0;i&lt;investors.length;i++){
            isInvestor=investors[i] == msg.sender;
            if(isInvestor){
                break;
            }
        }
        require(isInvestor);

        bool hasVoted =false;
        for(uint j=0;j&lt;payments.length;j++){
            hasVoted=payment.voters[j]==msg.sender;
            if(hasVoted){
                break;
            }
        }
        require(!hasVoted);
        payment.voters.push(msg.sender);
    }

    /**
    doPayment:完成资金支出
    需要指定是哪笔支出，即调用该接口给资金接收方转账，不能重复转账，并且赞成票数超过投资人数量的 50%
    */
    function doPayment(uint index) public{
        Payment storage payment=payments[index];
        require(!payment.completed);
        require(payment.voters.length &gt; (investors.length / 2));
        payment.receiver.transfer(payment.amount);
        payment.completed=true;
    }
}


</code></pre></div><h2 id="remix合约校验"><a href="#remix合约校验" class="header-anchor">#</a> Remix合约校验</h2> <blockquote><p>将智能合约源码放到<a href="https://remix.ethereum.org/" target="_blank" rel="noopener noreferrer">Remix<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上进行测试</p></blockquote> <ol><li>项目方身份创建:填写Deploy部署相关字段（描述，最低最高投资及总额等），transact办理即可
<img src="/images/shizhan3_1.png" alt="项目方"></li> <li>投资项目:
<ol><li>contribute 不需要填写参数，但是需要我们填写转账交易金额</li> <li>contribute 接口调用本质是发起了 Transaction，界面上看不到反馈，但在交易日志区域能看到新内容(截图2)</li> <li>investors查看投资人的信息(截图3)
<img src="/images/shizhan3_2.png" alt="投资"> <img src="/images/shizhan3_3.png" alt="console"> <img src="/images/shizhan3_4.png" alt="投资人1"></li></ol></li> <li>请求支出资金:
<ol><li>createPayment中填写对应参数</li> <li>payments查看详细的交易记录
<img src="/images/shizhan3_5.png" alt="请求支出"> <img src="/images/shizhan3_6.png" alt="createPayment记录"> <img src="/images/shizhan3_7.png" alt="payments记录"></li></ol></li> <li>资金请求投票(切换到投资人身份，给资金支出请求投票)/资金划转(项目方的身份，对投完票的资金支出进行资金划转)
1.切换账号，approvePayment[0]进行投票并payments[0]查看状态
2.切换项目方账号，doPayment[0]完成资金支出并payments[0]查看状态</li></ol> <h2 id="star-or-打赏"><a href="#star-or-打赏" class="header-anchor">#</a> star or 打赏</h2> <blockquote><p>Imtoken地址: 0x4a6Ac825993737a4f7F1ed12fcAc1b27e247c55A</p></blockquote> <blockquote><p>打赏码
<img src="/wxzz.jpg" alt="赞助支持"></p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/fe/block/project2.html" class="prev">ICO 智能合约的数据结构和接口设计</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2c921ca0.js" defer></script><script src="/assets/js/2.29093f4e.js" defer></script><script src="/assets/js/20.05a49d49.js" defer></script>
  </body>
</html>
